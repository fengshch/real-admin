<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password</title>
    <!-- jQuery -->
    <script src="/webjars/jquery/3.7.1/jquery.min.js"></script>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/webjars/bootstrap/5.3.3/css/bootstrap.min.css">
    <!-- Bootstrap JS -->
    <script src="/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="/static/assets/css/styles.css"/>
</head>
<body>
<div class="wrapper">
    <div id="messageContainer" class="message-container" style="display: none;"></div>
    <div class="container">
        <div class="card">
            <div class="card-header bg-transparent border-bottom-0">
                <h2 class="card-title">Reset Password</h2>
                <p class="card-description">Enter your new password</p>
            </div>
            <div class="card-content">
                <form id="resetPasswordForm">
                    <div class="form-group">
                        <label for="password" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="form-group mt-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                        <div class="invalid-feedback"></div>
                    </div>
                    <input type="hidden" id="token" name="token">
                    <button type="submit" class="btn btn-primary w-100 mt-3">Reset Password</button>
                </form>
                <p class="mt-6 text-center text-sm text-muted-foreground">
                    Remember your password? <a href="/login" class="font-medium text-primary">Login here</a>
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Set the token from the URL parameter
        var token = getUrlParameter('token');
        $('#token').val(token);

        function validateForm(formData) {
            let isValid = true;

            // Validate password
            if (formData.password.length < 8) {
                showError('#password', 'Password must be at least 8 characters long');
                isValid = false;
            } else {
                clearError('#password');
            }

            // Validate confirm password
            if (formData.password !== formData.confirmPassword) {
                showError('#confirmPassword', 'Passwords do not match');
                isValid = false;
            } else {
                clearError('#confirmPassword');
            }

            return isValid;
        }

        function showError(selector, message) {
            $(selector).addClass('is-invalid');
            $(selector).siblings('.invalid-feedback').text(message);
        }

        function clearError(selector) {
            $(selector).removeClass('is-invalid');
            $(selector).siblings('.invalid-feedback').text('');
        }

        function handleSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            if (validateForm(data)) {
                $.ajax({
                    url: '/api/reset-password',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(result) {
                        showMessage('Your password has been successfully reset.', 'success');
                        form.reset();
                        $(form).find('.is-invalid').removeClass('is-invalid');
                        $(form).find('.is-valid').removeClass('is-valid');
                        // Redirect to login page after 3 seconds
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 3000);
                    },
                    error: function(xhr) {
                        const errorData = JSON.parse(xhr.responseText);
                        showMessage(errorData.message || 'An error occurred. Please try again.', 'error');
                    }
                });
            }
        }

        function showMessage(message, type)
        {
            const messageContainer = $('#messageContainer');
            messageContainer.removeClass('success error').addClass(type);
            messageContainer.text(message);
            messageContainer.show();

            // Hide the message after 5 seconds
            setTimeout(() => {
                messageContainer.hide();
            }, 5000);
        }

        $('#resetPasswordForm').on('submit', handleSubmit);
    });
</script>
</body>
</html>